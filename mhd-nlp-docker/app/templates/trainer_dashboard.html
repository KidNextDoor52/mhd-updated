{% extends "base_trainer.html" %}
{% block title %}Trainer Dashboard{% endblock %}

{% block content %}
<div class="trainer-dashboard fade-in">

  <!-- Top heading -->
  <header class="trainer-header">
    <div>
      <h2>Trainer / Staff Command Center</h2>
      <p class="trainer-subtitle">
        Clear who‚Äôs red-flagged, who needs clearance, and how sessions are trending.
      </p>
    </div>
  </header>

  <!-- Quick actions row -->
  <div class="quick-actions-row">
    <button class="qa-btn primary" onclick="trainerGenerateDemo()">
      üîÅ Generate New Demo Predictions
    </button>
    <button class="qa-btn" onclick="trainerViewDrift()">
      üìà View Model Drift
    </button>
    <button class="qa-btn" onclick="trainerExportReport()">
      üìÑ Export Report
    </button>
  </div>

  <!-- Top metric tiles -->
  <div class="metric-grid">

    <!-- Injury risk counts -->
    <section class="metric-card">
      <header class="metric-header">
        <span class="metric-icon alert">‚ö†Ô∏è</span>
        <div>
          <h3>Injury Risk (Next {{ risk_window_days }} Days)</h3>
          <p class="metric-caption">Driven by training load, prior injuries, and notes NLP.</p>
        </div>
      </header>
      <div class="metric-body metric-cols">
        <div>
          <p class="metric-label">High risk</p>
          <p class="metric-value">{{ risk_counts.high or 0 }}</p>
        </div>
        <div>
          <p class="metric-label">Medium</p>
          <p class="metric-value">{{ risk_counts.med or 0 }}</p>
        </div>
        <div>
          <p class="metric-label">Low</p>
          <p class="metric-value">{{ risk_counts.low or 0 }}</p>
        </div>
      </div>
    </section>

    <!-- Risk distribution bars -->
    <section class="metric-card">
      <header class="metric-header">
        <span class="metric-icon">üìä</span>
        <div>
          <h3>Risk Distribution</h3>
          <p class="metric-caption">Last {{ risk_window_days }} days</p>
        </div>
      </header>
      <div class="metric-body">
        <div class="risk-chart">
          <div class="risk-bar high" style="width: {{ "%.1f"|format(risk_pct.high or 0) }}%">
            High ({{ risk_counts.high or 0 }})
          </div>
          <div class="risk-bar med" style="width: {{ "%.1f"|format(risk_pct.med or 0) }}%">
            Medium ({{ risk_counts.med or 0 }})
          </div>
          <div class="risk-bar low" style="width: {{ "%.1f"|format(risk_pct.low or 0) }}%">
            Low ({{ risk_counts.low or 0 }})
          </div>
        </div>
      </div>
    </section>

    <!-- Needs clearance list -->
    <section class="metric-card">
      <header class="metric-header">
        <span class="metric-icon danger">üõë</span>
        <div>
          <h3>Needs Clearance</h3>
          <p class="metric-caption">High-risk or recent-injury athletes, not yet cleared.</p>
        </div>
      </header>
      <div class="metric-body">
        <ul class="pill-list">
          {% for p in needs_clearance[:5] %}
            {% set md = p.get("meta", {}) %}
            <li class="pill-row">
              <div>
                <div class="pill-title">
                  {{ p.athlete_id or md.get("athlete_name","‚Äî") }}
                </div>
                <div class="pill-sub">
                  Risk {{ "%.2f"|format(p.score) }}
                </div>
              </div>
              <form method="post"
                    action="/trainer/clear/{{ p.athlete_id }}"
                    class="inline-form">
                <button type="submit" class="pill-btn">Clear</button>
              </form>
            </li>
          {% else %}
            <li class="pill-empty">
              No athletes currently waiting on clearance.
            </li>
          {% endfor %}
        </ul>
      </div>
    </section>

    <!-- Session quality summary -->
    <section class="metric-card">
      <header class="metric-header">
        <span class="metric-icon">‚úÖ</span>
        <div>
          <h3>Session Quality</h3>
          <p class="metric-caption">Last {{ session_window_days }} days</p>
        </div>
      </header>
      <div class="metric-body metric-cols">
        <div>
          <p class="metric-label">Sessions scored</p>
          <p class="metric-value">{{ sessions|length }}</p>
        </div>
        <div>
          <p class="metric-label">Avg quality</p>
          <p class="metric-value">
            {% if avg_session_score is not none %}
              {{ "%.1f"|format(avg_session_score) }}/5
            {% else %}
              ‚Äî
            {% endif %}
          </p>
        </div>
      </div>
    </section>
  </div>

  <!-- Lower panels -->
  <div class="panel-grid">

    <!-- Live high-risk table -->
    <section class="panel-card">
      <header class="panel-header">
        <h3>Live High-Risk Athletes</h3>
      </header>
      <div class="panel-body table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Athlete</th>
              <th>Score</th>
              <th>Updated</th>
            </tr>
          </thead>
          <tbody>
            {% for p in live_high %}
              {% set md = p.get("meta", {}) %}
              <tr>
                <td>{{ p.athlete_id or md.get("athlete_name","‚Äî") }}</td>
                <td>{{ "%.2f"|format(p.score) }}</td>
                <td>{{ p.ts }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3">No high-risk predictions in the last {{ risk_window_days }} days.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Top at-risk per athlete -->
    <section class="panel-card">
      <header class="panel-header">
        <h3>Top At-Risk Athletes</h3>
      </header>
      <div class="panel-body table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Athlete</th>
              <th>Risk Score</th>
              <th>Last Update</th>
              <th>Flags</th>
            </tr>
          </thead>
          <tbody>
            {% for p in top_high[:20] %}
              {% set md = p.get("meta", {}) %}
              <tr>
                <td>{{ p.athlete_id or md.get("athlete_name","‚Äî") }}</td>
                <td>{{ "%.2f"|format(p.score) }}</td>
                <td>{{ p.ts }}</td>
                <td>
                  {{ md.get("recent_injury_flag") and "recent injury " or "" }}
                  {{ md.get("high_load_flag") and "high load " or "" }}
                  {{ md.get("nlp_pain_any") and "pain in notes " or "" }}
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="4">No at-risk athletes yet.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    <!-- Recent sessions -->
    <section class="panel-card full-width">
      <header class="panel-header">
        <h3>Recent Session Scores</h3>
      </header>
      <div class="panel-body table-wrap">
        <table class="table">
          <thead>
            <tr>
              <th>Athlete</th>
              <th>Score</th>
              <th>When</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sessions[:30] %}
              <tr>
                <td>{{ s.athlete_id or s.get("athlete_name","‚Äî") }}</td>
                <td>{{ "%.1f"|format(s.score) }}</td>
                <td>{{ s.ts }}</td>
              </tr>
            {% else %}
              <tr>
                <td colspan="3">No recent sessions.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </section>

    

    <!-- Model performance charts panel -->
    <section class="panel-card full-width" id="model-performance-panel">
      <header class="panel-header">
        <h3>Model Performance Snapshot</h3>
      </header>
      <div class="panel-body">
        <div style="display:flex; flex-wrap:wrap; gap:1rem;">
          <div style="flex:1 1 260px; min-width:260px;">
            <p class="metric-label">Risk Bands (High / Med / Low)</p>
            <div style="height:220px;">
              <canvas id="trainerRiskChart"></canvas>
            </div>
          </div>
          {# placeholder second slot for future metrics if you want to add later #}
          <div style="flex:1 1 260px; min-width:260px;">
            <p class="metric-label">Sessions (last {{ session_window_days }} days)</p>
            <p class="metric-caption">
              {{ sessions|length }} scored sessions, average
              {% if avg_session_score is not none %}
                {{ "%.1f"|format(avg_session_score) }}/5.
              {% else %}
                ‚Äî.
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Model status -->
    <section class="panel-card full-width" id="model-panel">
      <header class="panel-header">
        <h3>Model Status</h3>
      </header>
      <div class="panel-body model-body">
        <div>
          <p class="metric-label">Model</p>
          <p class="metric-value">{{ model_name }}</p>
        </div>
        <div>
          <p class="metric-label">Version</p>
          <p class="metric-value">{{ model_version }}</p>
        </div>
        <div>
          <p class="metric-label">Drift</p>
          <p class="metric-value">
            {{ drift.direction|capitalize }} (Œî={{ "%.2f"|format(drift.delta) }})
          </p>
        </div>
      </div>
    </section>

  </div>

</div>

<script>
  async function trainerGenerateDemo() {
    await fetch("/trainer/demo/generate", { method: "POST" });
    window.location.reload();
  }

  function trainerViewDrift() {
    const el = document.getElementById("model-panel");
    if (el) el.scrollIntoView({ behavior: "smooth" });
  }

  function trainerExportReport() {
    window.location.href = "/trainer/report";
  }

  // Chart.js ‚Äì risk bands doughnut
  document.addEventListener("DOMContentLoaded", () => {
    if (!window.Chart) return;
    const canvas = document.getElementById("trainerRiskChart");
    if (!canvas) return;

    const ctx = canvas.getContext("2d");

    const high = {{ risk_counts.high or 0 }};
    const med  = {{ risk_counts.med  or 0 }};
    const low  = {{ risk_counts.low  or 0 }};

    new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["High", "Medium", "Low"],
        datasets: [{
          data: [high, med, low],
          backgroundColor: [
            "#ef4444", // high
            "#f97316", // medium
            "#22c55e"  // low
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "right",
            labels: { boxWidth: 14 }
          }
        },
        cutout: "55%"
      }
    });
  });
</script>
{% endblock %}
