{% extends "base.html" %}
{% block title %}Welcome - MHD{% endblock %}

{% block content %}
<div class="landing-container fade-in">
  <!-- Hero -->
  <div class="hero">
    <h2>Welcome to the MHD Portal</h2>
    <p class="tagline">Manage your health, performance, and records in one place.</p>
  </div>

  <!-- Forms Grid -->
  <div class="forms-grid">
    <!-- Login -->
    <div id="login-section" class="card auth-card">
      <h3>Login</h3>
      <form onsubmit="login(event)">
        <label>Email or Username:</label>
        <input name="username" required>
        <label>Password:</label>
        <input name="password" type="password" required>
        <button type="submit" class="btn primary">Login</button>
      </form>
      <div class="forgot-link">
        <a href="javascript:void(0)" onclick="toggleForgot()">Forgot Password?</a>
      </div>

      <!-- Hidden forgot form -->
      <div id="forgot-form" style="display:none; margin-top:1rem;">
        <form onsubmit="forgotPassword(event)">
          <label>Email:</label>
          <input name="email" type="email" required>
          <button type="submit" class="btn warning">Request Reset</button>
        </form>
      </div>

      <!-- Hidden reset form -->
      <div id="reset-form" style="display:none; margin-top:1rem;">
        <form onsubmit="resetPassword(event)">
          <label>Reset Token:</label>
          <input name="token" required>
          <label>New Password:</label>
          <input name="new_password" type="password" required>
          <button type="submit" class="btn success">Reset Password</button>
        </form>
      </div>
    </div>

    <!-- Signup -->
    <div id="signup-section" class="card auth-card">
      <h3>Create Account</h3>
      <form onsubmit="signup(event)">
        <label>Username:</label>
        <input name="username" required>
        <label>Email:</label>
        <input name="email" type="email" required>
        <label>Password:</label>
        <input name="password" type="password" required>
        <button type="submit" class="btn success">Sign Up</button>
      </form>
      <hr>
      <button onclick="googleLogin()" class="btn google-btn">
        <img src="/static/img/google-logo.png" alt="Google" class="google-icon">
        Sign in with Google
      </button>
    </div>

    <!-- Logout Section -->
    <div id="logout-section" class="card auth-card" style="display:none;">
      <p>You are logged in.</p>
      <button onclick="logout()" class="btn danger">Logout</button>
    </div>
  </div>
</div>

<script>
  function hasCookie(name) {
    return document.cookie.split("; ").some(c => c.startsWith(name + "="));
  }

  // Decide which cards to show
  function refreshAuthCards() {
    const loggedIn = localStorage.getItem("token") || hasCookie("token");
    document.getElementById("logout-section").style.display = loggedIn ? "block" : "none";
    document.getElementById("login-section").style.display  = loggedIn ? "none"  : "block";
    document.getElementById("signup-section").style.display = loggedIn ? "none"  : "block";
  }

  window.onload = () => {
    refreshAuthCards();
  };

  async function login(event) {
    event.preventDefault();
    const form = new FormData(event.target);
    try {
      const res = await fetch("/auth/token", {
        method: "POST",
        body: new URLSearchParams({
          username: form.get("username"),
          password: form.get("password")
        }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { detail: text || "Unknown error" }; }

      if (res.ok && data.access_token) {
        // Optional: store for UI toggles
        localStorage.setItem("token", data.access_token);
        // Backend also set cookies â†’ go to dashboard
        window.location.href = "/dashboard";
      } else {
        alert("Login failed: " + (data.detail || "Unknown error"));
      }
    } catch (e) {
      alert("Network error during login.");
    }
  }

  async function signup(event) {
    event.preventDefault();
    const formEl = event.target;
    const form = new FormData(formEl);
    try {
      const res = await fetch("/auth/signup", {  // <-- fixed path
        method: "POST",
        body: new URLSearchParams({
          username: form.get("username"),
          email: form.get("email"),
          password: form.get("password")
        }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });

      const text = await res.text();
      let data;
      try { data = JSON.parse(text); } catch { data = { detail: text || "Unknown error" }; }

      if (res.ok) {
        formEl.reset();
        alert("Account created! Please log in.");
        document.querySelector('#login-section input[name="username"]').focus();
      } else {
        alert("Signup failed: " + (data.detail || "Unknown error"));
      }
    } catch (e) {
      alert("Network error during signup.");
    }
  }

  async function forgotPassword(event) {
    event.preventDefault();
    const form = new FormData(event.target);
    try {
      const res = await fetch("/auth/forgot-password", {
        method: "POST",
        body: new URLSearchParams({ email: form.get("email") }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });
      if (res.ok) {
        alert("Reset token generated. Paste it below to reset your password.");
        document.getElementById("reset-form").style.display = "block";
      } else {
        const data = await res.json().catch(() => ({}));
        alert("Error: " + (data.detail || "Unknown error"));
      }
    } catch {
      alert("Network error during request.");
    }
  }

  async function resetPassword(event) {
    event.preventDefault();
    const form = new FormData(event.target);
    try {
      const res = await fetch("/auth/reset-password", {
        method: "POST",
        body: new URLSearchParams({
          token: form.get("token"),
          new_password: form.get("new_password")
        }),
        headers: { "Content-Type": "application/x-www-form-urlencoded" }
      });
      if (res.ok) {
        alert("Password reset successful! You can now log in.");
        document.getElementById("reset-form").style.display = "none";
        toggleForgot();
      } else {
        const data = await res.json().catch(() => ({}));
        alert("Reset failed: " + (data.detail || "Unknown error"));
      }
    } catch {
      alert("Network error during reset.");
    }
  }

  async function logout() {
    localStorage.removeItem("token");
    try { await fetch("/auth/logout", { method: "POST" }); } catch {}
    // Give cookies a tick to clear, then return to landing
    setTimeout(() => {
      refreshAuthCards();
      window.location.href = "/";
    }, 100);
  }

  function googleLogin() {
    window.location.href = "/auth/google/login";
  }

  function toggleForgot() {
    const f = document.getElementById("forgot-form");
    f.style.display = f.style.display === "none" ? "block" : "none";
  }
</script>

{% endblock %}
